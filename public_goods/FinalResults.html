{{ block title }}Resultados Finales{{ endblock }}

{{ block content }}

<div class="card mb-4">
    <div class="card-header bg-success text-white">
        <h3 class="mb-0"><i class="fas fa-trophy"></i> Resultados Finales del Experimento</h3>
    </div>
    <div class="card-body">
        <p class="lead">
            El experimento ha finalizado. A continuación se muestra el desglose completo 
            de tu ganancia incluyendo el efecto del sistema de castigo.
        </p>
    </div>
</div>

<!-- Resumen de Tu Ganancia -->
<div class="card mb-4 border-success">
    <div class="card-header bg-success text-white">
        <h4 class="mb-0">Tu Ganancia Final</h4>
    </div>
    <div class="card-body">
        <div class="text-center">
            <h1 class="display-3 text-success">{{ my_final_payoff }}</h1>
            <p class="lead">puntos</p>
        </div>
    </div>
</div>

<!-- Desglose Detallado de Tu Ganancia -->
<div class="card mb-4">
    <div class="card-header bg-info text-white">
        <h4 class="mb-0">Desglose Detallado de Tu Ganancia</h4>
    </div>
    <div class="card-body">
        
        <!-- Fase 1: Contribución -->
        <h5 class="border-bottom pb-2">Fase 1: Contribución al Fondo Común</h5>
        <div class="row mb-3">
            <div class="col-md-3">
                <p class="mb-1"><small>Dotación Inicial</small></p>
                <p class="h5">{{ endowment }}</p>
            </div>
            <div class="col-md-3">
                <p class="mb-1"><small>Tu Contribución</small></p>
                <p class="h5 text-danger">- {{ my_contribution }}</p>
            </div>
            <div class="col-md-3">
                <p class="mb-1"><small>Participación del Fondo</small></p>
                <p class="h5 text-success">+ {{ individual_share }}</p>
                <small class="text-muted d-block">
                    ({{ total_contribution }} × {{ multiplier }} ÷ 3)
                </small>
            </div>
            <div class="col-md-3">
                <p class="mb-1"><small><strong>Subtotal</strong></small></p>
                <p class="h5 text-primary">= {{ my_payoff_before_punishment }}</p>
            </div>
        </div>

        <!-- Fase 2: Castigos Dados -->
        <h5 class="border-bottom pb-2 mt-4">Fase 2: Castigos que Asignaste</h5>
        {% if my_punishments_given %}
            <table class="table table-sm table-bordered mb-3">
                <thead class="thead-light">
                    <tr>
                        <th>Jugador Castigado</th>
                        <th>Puntos de Castigo</th>
                        <th>Costo para Ti</th>
                    </tr>
                </thead>
                <tbody>
                    {% for punishment in my_punishments_given %}
                    <tr>
                        <td>Jugador {{ punishment.target_id }}</td>
                        <td>{{ punishment.amount }}</td>
                        <td class="text-danger">- {{ punishment.cost }}</td>
                    </tr>
                    {% endfor %}
                    <tr class="table-warning">
                        <td colspan="2"><strong>Total Costo de Castigar:</strong></td>
                        <td class="text-danger"><strong>- {{ my_total_punishment_cost }}</strong></td>
                    </tr>
                </tbody>
            </table>
        {% else %}
            <div class="alert alert-secondary">
                <p class="mb-0">No asignaste castigos a ningún jugador.</p>
            </div>
        {% endif %}

        <!-- Fase 3: Castigos Recibidos -->
        <h5 class="border-bottom pb-2 mt-4">Fase 3: Castigos que Recibiste</h5>
        {% if my_punishments_received %}
            <table class="table table-sm table-bordered mb-3">
                <thead class="thead-light">
                    <tr>
                        <th>De Jugador</th>
                        <th>Puntos de Castigo</th>
                        <th>Efecto en Ti (×{{ punishment_effect }})</th>
                    </tr>
                </thead>
                <tbody>
                    {% for punishment in my_punishments_received %}
                    <tr>
                        <td>Jugador {{ punishment.from_id }}</td>
                        <td>{{ punishment.amount }}</td>
                        <td class="text-danger">- {{ punishment.effect }}</td>
                    </tr>
                    {% endfor %}
                    <tr class="table-warning">
                        <td colspan="2"><strong>Total Efecto del Castigo:</strong></td>
                        <td class="text-danger"><strong>- {{ my_total_punishment_effect }}</strong></td>
                    </tr>
                </tbody>
            </table>
        {% else %}
            <div class="alert alert-success">
                <p class="mb-0"><i class="fas fa-check-circle"></i> No recibiste castigos de otros jugadores.</p>
            </div>
        {% endif %}

        <!-- Cálculo Final -->
        <div class="card bg-light mt-4">
            <div class="card-body">
                <h5>Cálculo de Tu Ganancia Final:</h5>
                <div class="row">
                    <div class="col-md-12">
                        <p class="mb-2">
                            <span class="badge badge-primary">Ganancia antes del castigo</span>
                            <strong>{{ my_payoff_before_punishment }}</strong>
                        </p>
                        <p class="mb-2">
                            <span class="badge badge-danger">- Costo de castigar</span>
                            <strong>{{ my_total_punishment_cost }}</strong>
                        </p>
                        <p class="mb-2">
                            <span class="badge badge-danger">- Efecto del castigo recibido</span>
                            <strong>{{ my_total_punishment_effect }}</strong>
                        </p>
                        <hr>
                        <p class="h4">
                            <span class="badge badge-success">= Ganancia Final</span>
                            <strong class="text-success">{{ my_final_payoff }}</strong> puntos
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Tabla de Resultados del Grupo -->
<div class="card mb-4">
    <div class="card-header bg-secondary text-white">
        <h4 class="mb-0">Resultados de Todos los Jugadores</h4>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped table-bordered">
                <thead class="thead-dark">
                    <tr>
                        <th>Jugador</th>
                        <th>Contribución</th>
                        <th>Ganancia antes del castigo</th>
                        <th>Castigos dados</th>
                        <th>Costo pagado</th>
                        <th>Castigos recibidos</th>
                        <th>Efecto (×3)</th>
                        <th>Ganancia Final</th>
                    </tr>
                </thead>
                <tbody>
                    {% for p in players_info %}
                    <tr {% if p.id_in_group == player.id_in_group %}class="table-warning"{% endif %}>
                        <td>
                            <strong>Jugador {{ p.id_in_group }}</strong>
                            {% if p.id_in_group == player.id_in_group %}
                                <span class="badge badge-warning">Tú</span>
                            {% endif %}
                        </td>
                        <td>{{ p.contribution }}</td>
                        <td>{{ p.payoff_before_punishment }}</td>
                        <td>{{ p.punishment_given }}</td>
                        <td class="text-danger">{{ p.punishment_cost }}</td>
                        <td>{{ p.punishment_received }}</td>
                        <td class="text-danger">{{ p.punishment_effect }}</td>
                        <td><strong>{{ p.final_payoff }}</strong></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <p class="text-muted mt-3">
            <small>
                <i class="fas fa-info-circle"></i> 
                La fila resaltada en amarillo muestra tus resultados.
            </small>
        </p>
    </div>
</div>

<!-- Información Final -->
<div class="alert alert-info">
    <h5><i class="fas fa-info-circle"></i> Gracias por Participar</h5>
    <p class="mb-0">
        Has completado el experimento de Bienes Públicos con sistema de castigo.
        Tu ganancia final es de <strong>{{ my_final_payoff }}</strong> puntos.
    </p>
</div>

{{ next_button }}

{{ endblock }}